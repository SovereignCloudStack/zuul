---

- name: generate SSH key for nodepool
  hosts: localhost
  tasks:
    - community.crypto.openssh_keypair:
        path: "{{ playbook_dir }}/nodepool"
        type: rsa
        size: 4096
        state: present

# - name: Pull caddy docker container
#   hosts: zuul
#   become: true
#   pre_tasks:
#     - name: Creates directory
#       file:
#         path: /opt/caddy
#         state: directory
#     - name: Copy file with owner and permissions
#       ansible.builtin.copy:
#         src: Caddyfile
#         dest: /opt/caddy/Caddyfile
#         owner: root
#         group: root
#         mode: '0644'
#   tasks:
#     - docker_image:
#         name: "caddy"
#         source: pull
#         state: present
#     - docker_container:
#         name: caddy
#         image: caddy
#         state: started
#         networks:
#           - name: "zuul_default"
#         ports:
#           - "0.0.0.0:80:80/tcp"
#           - "0.0.0.0:443:443/tcp"
#         volumes:
#           - /opt/caddy/Caddyfile:/etc/caddy/Caddyfile
      
- name: setup zuul playbook
  hosts: zuul
  vars_files:
        - ./zuul-config.yaml
  pre_tasks:
    - name: install openstacksdk python libraries
      become: true
      ansible.builtin.pip:
        name: openstacksdk
        version: 0.61.0

    - name: Create /etc/openstack/
      ansible.builtin.file:
        state: directory
        path: /etc/openstack
        owner: root
        group: root
        mode: 0755
      become: true

    - name: Deploy clouds.yaml file
      ansible.builtin.copy:
        src: clouds.yaml
        dest: /etc/openstack/clouds.yaml
        owner: root
        group: zuul
        mode: '0640'
      become: true

    - name: Create keypair in the cloud
      openstack.cloud.keypair:
        cloud: wavestack
        name: nodepool
        public_key: "{{ lookup('file', 'nodepool.pub') }}"
      become: true

    - name: install docker python libraries
      become: true
      ansible.builtin.pip:
        name: docker

    - name: install docker-compose python libraries
      become: true
      ansible.builtin.pip:
        name: docker-compose
  roles:
     - name: setup zuul role
       role: osism.services.zuul
       vars:
        zuul_connections:
          github:
            driver: github
            webhook_token: "{{ webhook_token }}"
            app_id: "{{ github_app_id }}"
            app_key: "/etc/zuul/pem-files/{{ github_pem_name }}.pem"
          opendevorg:
            name: opendev
            driver: git
            baseurl: https://opendev.org
        zuul_tenants:
          - tenant:
              name: my-tenant-name
              source:
                opendevorg:
                  untrusted-projects:
                    - zuul/zuul-jobs:
                        include:
                          - job
                github:
                  config-projects:
                    - my-org/zuul_demo_config:
                        load-branch: main
                  untrusted-projects:
                    - my-org/zuul_demo_repo
       become: true

